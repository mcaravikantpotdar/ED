<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PMIS Command v7.1 | Pro Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  
  <style>
    :root { --p: #0f172a; --a: #3b82f6; --bg: #f8fafc; --card: #ffffff; }
    body { background-color: var(--bg); font-family: 'Inter', sans-serif; color: #1e293b; }
    
    /* Cinematic Symphony Loader */
    #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    .pulse { width: 60px; height: 60px; border: 4px solid #f1f5f9; border-top-color: var(--a); border-radius: 50%; animation: spin 1s infinite linear; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #vMsg { margin-top: 25px; font-weight: 600; color: var(--p); }

    /* Admin UI Styles */
    .orch-row { border-bottom: 1px solid #f1f5f9; padding: 15px 0; display: flex; align-items: center; }
    .move-btn { cursor: pointer; color: #94a3b8; transition: 0.2s; font-size: 1.8rem; }
    .move-btn:hover { color: var(--a); }
    .settings-cog { cursor: pointer; color: #94a3b8; margin-left: 10px; }
    .settings-cog:hover { color: var(--p); }
    
    .property-drawer { background: #f1f5f9; padding: 20px; border-radius: 12px; margin-top: 10px; display: none; border: 1px solid #e2e8f0; width: 100%; }
    
    /* Layout */
    .app-header { background: var(--p); color: white; padding: 40px 0; border-radius: 0 0 30px 30px; margin-bottom: 30px; position: relative; }
    .section-card { background: var(--card); border-radius: 20px; padding: 30px; margin-bottom: 30px; border: 1px solid #e2e8f0; }
    .atomic-btn { position: absolute; right: 10px; top: 12px; opacity: 0; transform: translateX(10px); transition: 0.3s; cursor: pointer; color: var(--a); background: white; z-index: 10; }
    .atomic-btn.visible { opacity: 1; transform: translateX(0); }
    .u-case { text-transform: uppercase; }
  </style>
</head>
<body>

  <div id="loader"><div class="pulse"></div><p id="vMsg">Synchronizing Project DNA...</p></div>

  <div id="adminModal" class="modal modal-fixed-footer" style="width: 95%; height: 90%; border-radius: 20px;">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h4><i class="material-icons left blue-text">tune</i> Database Orchestrator</h4>
        <button class="btn green accent-4" onclick="createNewSection()"><i class="material-icons left">add</i> New Section</button>
      </div>
      <p class="grey-text">Use arrows to reorder. Click the cog for property settings.</p>
      <div id="orchList"></div>
    </div>
    <div class="modal-footer">
      <button class="modal-close btn-flat">Close</button>
    </div>
  </div>

  <div id="appBody" style="display:none;">
    <header class="app-header">
      <div class="container">
        <h3 id="orgTitle" style="margin:0; font-weight:900;">Portal</h3>
        <i class="material-icons" style="position:absolute; right:20px; top:20px; cursor:pointer;" onclick="openAdmin()">settings</i>
      </div>
    </header>

    <div class="container">
      <div class="section-card" style="margin-top:-60px; position:relative;">
        <div class="row" style="margin-bottom:0">
          <div class="input-field col s12 m5"><input type="text" id="pmis_in"><label>PMIS CODE</label></div>
          <div class="input-field col s12 m5"><input type="text" id="dob_in" placeholder="DD-MM-YYYY"><label>DATE OF BIRTH</label></div>
          <div class="col s12 m2"><button class="btn-large blue accent-4 w100" style="width:100%; border-radius:12px;" onclick="search()">LOAD</button></div>
        </div>
      </div>
      <div id="formContainer"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    // PRECISE URL BINDING
    const API = 'https://script.google.com/macros/s/AKfycbxk570Yj2DRGZcEWBB2E8BwHZOxDfO6i5TSF_NKyjso65ct2j0pbNiE5edQ-_aAyHi0sQ/exec';
    let SID = localStorage.getItem('pmis_v6_sid');
    let MASTER_SCHEMA = [];

    window.onload = () => {
      M.Modal.init(document.querySelectorAll('.modal'), {dismissible: false});
      if(!SID) { SID = prompt("Provide Google Sheet ID to connect:"); localStorage.setItem('pmis_v6_sid', SID); location.reload(); }
      startup();
    };

    function startup() {
      call({action: 'checkStatus', sheetId: SID}, res => {
        if(res.status === "NEW") provision(); else initApp();
      });
    }

    function initApp() {
      call({action: 'init', sheetId: SID}, res => {
        MASTER_SCHEMA = res.schema;
        document.getElementById('orgTitle').innerText = res.settings.ORG_NAME;
        renderMainForm(res.schema);
        document.getElementById('loader').style.display = 'none';
        document.getElementById('appBody').style.display = 'block';
      });
    }

    function renderMainForm(schema) {
      const cont = document.getElementById('formContainer');
      cont.innerHTML = '';
      const sections = [...new Set(schema.map(f => f.Section))].sort();
      
      sections.forEach(sec => {
        const card = document.createElement('div');
        card.className = 'section-card';
        card.innerHTML = `<div style="font-size:1.4rem; font-weight:800; margin-bottom:20px; color:var(--p)">${sec}</div><div class="row"></div>`;
        const row = card.querySelector('.row');
        schema.filter(f => f.Section === sec).sort((a,b)=>a.Order-b.Order).forEach(f => {
          row.innerHTML += `
            <div class="input-field col s12 m4" style="position:relative">
              <input type="text" name="${f.ID}" class="u-case d-in"><label>${f.Label}</label>
              <i class="material-icons atomic-btn" onclick="save(this)">save</i>
            </div>`;
        });
        cont.appendChild(card);
      });
      M.updateTextFields();
      document.querySelectorAll('.d-in').forEach(i => i.oninput = (e) => e.target.parentElement.querySelector('.atomic-btn').classList.add('visible'));
    }

    // --- 360Â° ADMIN ORCHESTRATOR ---
    function openAdmin() {
      const pass = prompt("Enter Admin Security Key:");
      call({action: 'init', sheetId: SID}, res => {
        if(String(pass) === String(res.settings.ADMIN_PASSWORD)) {
          buildOrchestrator();
          M.Modal.getInstance(document.getElementById('adminModal')).open();
        } else alert("Invalid Key");
      });
    }

    function buildOrchestrator() {
      const list = document.getElementById('orchList');
      list.innerHTML = '';
      const sections = [...new Set(MASTER_SCHEMA.map(f => f.Section))];
      
      MASTER_SCHEMA.sort((a,b) => a.Order - b.Order).forEach((f, idx) => {
        const row = document.createElement('div');
        row.className = 'orch-row row';
        row.innerHTML = `
          <div class="col s1 center-align">
            <i class="material-icons move-btn" onclick="moveElement('up', ${idx})">expand_less</i>
            <i class="material-icons move-btn" onclick="moveElement('down', ${idx})">expand_more</i>
          </div>
          <div class="col s5"><strong>${f.Label}</strong></div>
          <div class="col s4 blue-text">${f.Section}</div>
          <div class="col s2 center-align">
            <i class="material-icons settings-cog" onclick="togglePropertyDrawer('${f.ID}')">settings</i>
          </div>
          <div class="property-drawer col s12" id="drawer_${f.ID.replace(/\s/g,'')}">
            <div class="row" style="margin-bottom:0">
              <div class="col s6">
                <label>Move to Section</label>
                <select class="browser-default" id="sec_${f.ID.replace(/\s/g,'')}">
                  ${sections.map(s => `<option value="${s}" ${f.Section === s ? 'selected':''}>${s}</option>`).join('')}
                </select>
              </div>
              <div class="col s6">
                <label>Data Property</label>
                <select class="browser-default" id="typ_${f.ID.replace(/\s/g,'')}">
                  <option value="TEXT" ${f.Type === 'TEXT'?'selected':''}>Standard Text</option>
                  <option value="DATE" ${f.Type === 'DATE'?'selected':''}>Date Format</option>
                  <option value="DROPDOWN" ${f.Type === 'DROPDOWN'?'selected':''}>Dropdown List</option>
                </select>
              </div>
              <div class="col s12" style="margin-top:15px">
                <button class="btn blue darken-2" onclick="updateFieldProperties('${f.ID}')">Sync Properties</button>
              </div>
            </div>
          </div>
        `;
        list.appendChild(row);
      });
    }

    function moveElement(dir, idx) {
      const target = dir === 'up' ? idx - 1 : idx + 1;
      if(target < 0 || target >= MASTER_SCHEMA.length) return;
      document.getElementById('loader').style.display = 'flex';
      call({action: 'swapOrder', sheetId: SID, idA: MASTER_SCHEMA[idx].ID, idB: MASTER_SCHEMA[target].ID}, () => location.reload());
    }

    function togglePropertyDrawer(id) {
      const d = document.getElementById('drawer_' + id.replace(/\s/g,''));
      d.style.display = d.style.display === 'block' ? 'none' : 'block';
    }

    function createNewSection() {
      const name = prompt("Enter New Section Name:");
      if(!name) return;
      // Section is created when the first field is mapped to it.
      alert(`Section "${name}" prepared. Use the Settings Cog on any field to map it here.`);
    }

    function updateFieldProperties(id) {
      const sec = document.getElementById('sec_' + id.replace(/\s/g,'')).value;
      const typ = document.getElementById('typ_' + id.replace(/\s/g,'')).value;
      const field = MASTER_SCHEMA.find(f => f.ID === id);
      call({action: 'updateField', sheetId: SID, payload: {ID: id, Section: sec, Type: typ, Order: field.Order}}, () => location.reload());
    }

    // --- SYSTEM CORE ---
    function call(d, cb) { fetch(API, {method: 'POST', body: JSON.stringify(d)}).then(r => r.json()).then(cb).catch(e => alert("Connection Lost")); }
    function provision() { const org = prompt("Org Name?"); const pass = prompt("Admin Password?"); call({action: 'provision', sheetId: SID, orgName: org, password: pass}, () => location.reload()); }
    function search() {
      call({action: 'search', sheetId: SID, pmis: document.getElementById('pmis_in').value, dob: document.getElementById('dob_in').value}, res => {
        if(res.notFound) return M.toast({html: 'No record found'});
        Object.keys(res).forEach(k => { const i = document.getElementsByName(k)[0]; if(i) { i.value = res[k]; i.dispatchEvent(new Event('input')); }});
      });
    }
    function save(btn) {
      const input = btn.parentElement.querySelector('input');
      call({action: 'atomicSave', sheetId: SID, pmis: document.getElementById('pmis_in').value, fieldName: input.name, newValue: input.value.toUpperCase()}, () => {
        btn.innerHTML = 'check_circle'; btn.style.color = 'green';
        setTimeout(() => btn.classList.remove('visible'), 2000);
      });
    }
  </script>
</body>
</html>
